<!-- <link rel="import" href="../polymer/polymer-element.html"> -->
<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="bower_components/iron-selector/iron-selectable.html">

<dom-module id="iron-accordion-pages">
  <template>
    <style>
      :host {
        display: block;
        --iron-accordion-pages-transition: 1.4s ease-out;
      }

      .container {
        position: relative;
        width: 100%;
        height: 100%;
      }

      .container ::slotted([slot=items]) {
        position: absolute;

        height: 100%;

        -webkit-transition: var(--iron-accordion-pages-transition);
        -moz-transition: var(--iron-accordion-pages-transition);
        -ms-transition: var(--iron-accordion-pages-transition);
        -o-transition: var(--iron-accordion-pages-transition);
        transition: var(--iron-accordion-pages-transition);
        will-change: transform;
      }
    </style>
    <div class="container">
      <slot name="items"></slot>
    </div>

  </template>

  <script>
    /**
     * `iron-accordion-pages`
     * Multi animated pages presentation element in an 'accordion' aspect
     */
    class IronAccordionPages extends Polymer.mixinBehaviors([Polymer.IronResizableBehavior, Polymer.IronSelectableBehavior], Polymer.Element) {
      static get is() { return 'iron-accordion-pages'; }
      static get properties() {
        return {
          leftInterItemOffset: {
            type: Number,
            value: 100,
            notify: true,
          },
          leftOffset: {
            type: Number,
            value: 300,
            notify: true,
          },
          rightOffset: {
            type: Number,
            value: 300,
            notify: true,
          },
          rightInterItemOffset: {
            type: Number,
            value: 100,
            notify: true,
          },
        };
      }
      static get observers() {
        return [
          '_handleItemsChanged(items)',
          '_handleSelectedChanged(selected)',
          '_handleLayoutPropertiesChange(leftInterItemOffset,leftOffset,rightOffset,rightInterItemOffset)'
        ];
      }
      _handleSelectedChanged(selected) {
        this.layoutItems(true);
      }
      _handleItemsChanged(items) {
        if (!this.selected) {
          if (items.length > 0) {
            this.selectIndex(0);
            this.layoutItems(false);
          }
          return;
        }
        this.layoutItems(false);
      }
      _handleLayoutPropertiesChange(leftInterItemOffset, leftOffset, rightOffset, rightInterItemOffset) {
        console.log("_handleLayoutPropertiesChange");
        this.layoutItems(false);
      }
      layoutItems(animated) {
        let selectedItem = this.selected;
        if (!selectedItem) {
          return;
        }

        let selectedItemIndex = this._valueToIndex(selectedItem);
        const items = this.items;
        for (var i = 0, item; item = this.items[i]; i++) {
          if (!animated) {
            item.style.transition = 'none';
          }
          const itemLeft = this._getItemLeft(i, selectedItemIndex);
          console.log(`Selected: ${selectedItemIndex} - Item ${i}: Left = ${itemLeft} (${this._calcPercentage(itemLeft / this.offsetWidth)})`);
          this._animateElementSetStyle(item, itemLeft);

          if (!animated) {
            item.style.transition = '';
          }
        }
      }
      _animateElementSetStyle(element, toLeft) {
        const width = this.offsetWidth;
        let toLeftPercent = this._calcPercentage(toLeft / width);
        const transform = `translate3d(${toLeftPercent}, 0, 0)`;
        element.style.transform = transform;
        element.style.webkitTransform = transform;
        element.style.MozTransform = transform;
        element.style.msTransform = transform;
        element.style.OTransform = transform;
      }
      _getItemLeftOld(itemIndex, selectedItemIndex) {
        let selectedIndexDiff = itemIndex - selectedItemIndex;
        if (selectedIndexDiff === 0) {
          return 0;
        }
        if (selectedIndexDiff < 0) {
          selectedIndexDiff = -selectedIndexDiff;
          const offset = this.previousFirstOffset + (selectedIndexDiff - 1) * this.previousSecondOffset;
          return -offset;
        }
        return this.nextFirstOffset + (selectedIndexDiff - 1) * this.nextSecondOffset;
      }
      _getItemLeft(itemIndex, selectedItemIndex) {
        const width = this.offsetWidth;
        if (!width) {
          console.error("_getItemLeft: Element has no width !");
          return;
        }

        let selectedIndexDiff = itemIndex - selectedItemIndex;
        if (selectedIndexDiff === 0) {
          return 0;
        }
        if (selectedIndexDiff < 0) {
          selectedIndexDiff = -selectedIndexDiff;
          const offset = width + Number(this.leftOffset) + (selectedIndexDiff - 1) * Number(this.leftInterItemOffset);
          return -offset;
        }
        return width + Number(this.rightOffset) + (selectedIndexDiff - 1) * Number(this.rightInterItemOffset);
      }
      _calcPercentage(value) {
        value = value.toFixed(2);
        return `${value * 100}%`;
      }
    }

    window.customElements.define(IronAccordionPages.is, IronAccordionPages);
  </script>
</dom-module>